<%- include('partials/header') %>

<div class="jumbotron text-center">
  <h1 class="display-3">You've Discovered Secrets!</h1>
  <a class="btn btn-light btn-lg" href="/logout">Log Out</a>
  <a class="btn btn-dark btn-lg" href="/submit">Submit a Secret</a>
</div>

<% if (message) { %>
  <div class="alert alert-success alert-dismissible fade show text-center" role="alert">
    <%= message %>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
<% } %>

<div class="container">
  <div class="row">

    <% if (currentUser && currentUser.secrets && currentUser.secrets.length > 0) { %>
  <% currentUser.secrets.forEach((secret, index) => { %>
    <div class="col-12">
      <div class="card my-3 border-primary">
        <div class="card-body secret-text">
          <% if (editEmail === currentUser.email && editIndex == index.toString()) { %>
            <form class="updateSecretForm">
              <input type="hidden" name="index" value="<%= index %>">
              <input type="text" name="updatedSecret" class="form-control" value="<%= secret %>" required>
              <button type="submit" class="btn btn-dark mt-2">Update</button>
            </form>
          <% } else { %>
            <p><%= secret %></p>
            <form action="/secrets" method="GET" class="d-inline">
              <input type="hidden" name="edit" value="<%= currentUser.email %>">
              <input type="hidden" name="index" value="<%= index %>">
              <button type="submit" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-edit"></i> Edit
              </button>
            </form>
          <% } %>
        </div>
      </div>
    </div>
  <% }); %>
<% } %>


    <% if (otherUsers.length > 0) { %>
      <% otherUsers.forEach(user => { %>
  <% user.secrets.forEach(secret => { %>
    <div class="col-12">
      <div class="card my-3">
        <div class="card-body secret-text">
          <p><%= secret %></p>
        </div>
      </div>
    </div>
  <% }) %>
<% }) %>
  %>
      <p class="text-muted text-center">No other secrets submitted yet.</p>
    <% } %>

  </div>
</div>

<script>
  document.querySelectorAll('.updateSecretForm').forEach(form => {
    form.addEventListener("submit", async function (e) {
      e.preventDefault();
      const updatedSecret = form.querySelector("[name='updatedSecret']").value;
      const index = form.querySelector("[name='index']").value;

      try {
        const response = await fetch("/update-secret", {
          method: "PUT",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ updatedSecret, index })
        });

        const result = await response.json();
        if (response.ok) {
          alert(result.message || "Secret updated.");
          window.location.href = "/secrets";
        } else {
          alert(result.error || "Failed to update secret.");
        }
      } catch (error) {
        console.error("Update failed:", error);
        alert("Error while updating secret.");
      }
    });
  });
</script>


</body>
</html>
